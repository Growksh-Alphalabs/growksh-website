name: React Auto Infra Deploy (S3 + CloudFront + Route53)

on:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      domain_name:
        description: "Your domain (example.com)"
        required: false
      hosted_zone_id:
        description: "Route53 Hosted Zone ID"
        required: false

concurrency:
  group: deploy-react
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      DOMAIN_NAME: ${{ github.event.inputs.domain_name }}
      HOSTED_ZONE_ID: ${{ github.event.inputs.hosted_zone_id }}

    steps:
      - name: ✅ Checkout Repo
        uses: actions/checkout@v4

      - name: ✅ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: ✅ Install & Build
        run: |
          npm ci
          npm run build

      - name: ✅ Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ✅ CREATE OR USE S3 BUCKET
      - name: ✅ Ensure S3 bucket exists (use provided or create)
        run: |
          if [ -n "$S3_BUCKET" ]; then
            echo "Using provided S3_BUCKET: $S3_BUCKET"
            # verify bucket exists
            if aws s3api head-bucket --bucket "$S3_BUCKET" 2>/dev/null; then
              echo "Bucket exists: $S3_BUCKET"
            else
              echo "Provided S3_BUCKET '$S3_BUCKET' does not exist or is inaccessible";
              exit 1
            fi

            # Smoke-test the provided bucket's website endpoint — try to detect 403 cases early
            ENDPOINT="http://$S3_BUCKET.s3-website.$AWS_REGION.amazonaws.com/"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT")
            echo "Website endpoint returned HTTP $HTTP_CODE"
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Attempting to make objects public and re-sync to S3 for provided bucket"
              if [ -d "dist" ]; then
                aws s3 sync dist/ s3://$S3_BUCKET --acl public-read --delete || true
              elif [ -d "build" ]; then
                aws s3 sync build/ s3://$S3_BUCKET --acl public-read --delete || true
              fi
              sleep 3
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT")
              echo "After public-read sync, website endpoint returned HTTP $HTTP_CODE"
              if [ "$HTTP_CODE" -ne 200 ]; then
                echo "::warning::Provided bucket website endpoint still not reachable (HTTP $HTTP_CODE). Falling back to CloudFront OAC + private-bucket configuration."
                echo "FALLBACK_OAC=true" >> $GITHUB_ENV
                echo "FALLBACK_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
              fi
            fi
            fi
          else
            BUCKET_NAME=react-${{ github.repository_owner }}-${{ github.event.repository.name }}-deploy
            SANITIZED=$(echo "$BUCKET_NAME" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9.-]//g')

            LEN=${#SANITIZED}
            if [ "$LEN" -lt 3 ] || [ "$LEN" -gt 63 ]; then
              echo "::error::Generated bucket name invalid: $SANITIZED"; exit 1;
            fi

            echo "Creating bucket: $SANITIZED"
            echo "S3_BUCKET=$SANITIZED" >> $GITHUB_ENV

            if [ "$AWS_REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$SANITIZED"
            else
              aws s3api create-bucket --bucket "$SANITIZED" --create-bucket-configuration LocationConstraint=$AWS_REGION
            fi

            aws s3 website s3://$SANITIZED --index-document index.html --error-document index.html

            aws s3api put-public-access-block --bucket "$SANITIZED" \
              --public-access-block-configuration BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false

            POLICY_JSON=$(printf '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":"*","Action":["s3:GetObject"],"Resource":["arn:aws:s3:::%s/*"]}]}' "$SANITIZED")
            aws s3api put-bucket-policy --bucket "$SANITIZED" --policy "$POLICY_JSON"

            # Quick smoke-test: ensure website endpoint is publicly reachable. If not, attempt to make objects public.
            ENDPOINT="http://$SANITIZED.s3-website.$AWS_REGION.amazonaws.com/"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT")
            echo "Website endpoint returned HTTP $HTTP_CODE"
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Attempting to make objects public and re-sync to S3"
              # If build output exists, try syncing with public ACL so objects are readable (accounts with public access allowed)
              if [ -d "dist" ]; then
                aws s3 sync dist/ s3://$SANITIZED --acl public-read --delete || true
              elif [ -d "build" ]; then
                aws s3 sync build/ s3://$SANITIZED --acl public-read --delete || true
              fi
              sleep 3
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT")
              echo "After public-read sync, website endpoint returned HTTP $HTTP_CODE"
              if [ "$HTTP_CODE" -ne 200 ]; then
                echo "::warning::Website endpoint still not reachable (HTTP $HTTP_CODE). Falling back to CloudFront OAC + private-bucket configuration."
                echo "FALLBACK_OAC=true" >> $GITHUB_ENV
                echo "FALLBACK_BUCKET=$SANITIZED" >> $GITHUB_ENV
              fi
            fi
          fi

      # ✅ CREATE OR USE CLOUDFRONT
      - name: ✅ Ensure CloudFront distribution exists (use provided or create)
        run: |
          if [ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
            echo "Using provided CloudFront distribution ID: $CLOUDFRONT_DISTRIBUTION_ID"
            # verify distribution exists
            if aws cloudfront get-distribution --id "$CLOUDFRONT_DISTRIBUTION_ID" >/dev/null 2>&1; then
              echo "Found distribution $CLOUDFRONT_DISTRIBUTION_ID"
              echo "CLOUDFRONT_DISTRIBUTION_ID=$CLOUDFRONT_DISTRIBUTION_ID" >> $GITHUB_ENV
            else
              echo "::warning::Provided CLOUDFRONT_DISTRIBUTION_ID '$CLOUDFRONT_DISTRIBUTION_ID' not found — creating a new distribution."
              ORIGIN="$S3_BUCKET.s3-website.$AWS_REGION.amazonaws.com"

              DIST_CONFIG=$(printf "{\"CallerReference\":\"deploy-%s\",\"Comment\":\"CI Distribution\",\"Enabled\":true,\"Origins\":{\"Quantity\":1,\"Items\":[{\"Id\":\"S3WebsiteOrigin\",\"DomainName\":\"%s\",\"CustomOriginConfig\":{\"HTTPPort\":80,\"HTTPSPort\":443,\"OriginProtocolPolicy\":\"http-only\"}}]},\"DefaultCacheBehavior\":{\"TargetOriginId\":\"S3WebsiteOrigin\",\"ViewerProtocolPolicy\":\"redirect-to-https\",\"AllowedMethods\":{\"Quantity\":2,\"Items\":[\"GET\",\"HEAD\"]},\"ForwardedValues\":{\"QueryString\":false,\"Cookies\":{\"Forward\":\"none\"}},\"MinTTL\":0,\"DefaultTTL\":86400,\"MaxTTL\":31536000},\"CustomErrorResponses\":{\"Quantity\":1,\"Items\":[{\"ErrorCode\":404,\"ResponsePagePath\":\"/index.html\",\"ResponseCode\":\"200\"}]}}" "$(date +%s)" "$ORIGIN")
                DIST_ID=$(aws cloudfront create-distribution --distribution-config "$DIST_CONFIG" --query "Distribution.Id" --output text)
                echo "CLOUDFRONT_DISTRIBUTION_ID=$DIST_ID" >> $GITHUB_ENV
            fi
          else
            ORIGIN="$S3_BUCKET.s3-website.$AWS_REGION.amazonaws.com"
            # If earlier S3 website smoke-test flagged FALLBACK_OAC, create an OAC and a REST-origin distribution
            if [ "${FALLBACK_OAC}" = "true" ]; then
              echo "Creating CloudFront Origin Access Control (OAC) for secure S3 access"
              OAC_ID=$(aws cloudfront create-origin-access-control --origin-access-control-config "{\"Name\":\"ci-oac-$(date +%s)\",\"SigningProtocol\":\"sigv4\",\"SigningBehavior\":\"always\",\"OriginAccessControlOriginType\":\"s3\"}" --query "OriginAccessControl.Id" --output text)
              echo "Created OAC: $OAC_ID"

              REST_ORIGIN="$FALLBACK_BUCKET.s3.$AWS_REGION.amazonaws.com"

              DIST_CONFIG=$(printf "{\"CallerReference\":\"deploy-%s\",\"Comment\":\"CI Distribution (OAC)\",\"Enabled\":true,\"Origins\":{\"Quantity\":1,\"Items\":[{\"Id\":\"S3RestOrigin\",\"DomainName\":\"%s\",\"OriginAccessControlId\":\"%s\",\"S3OriginConfig\":{} }]},\"DefaultCacheBehavior\":{\"TargetOriginId\":\"S3RestOrigin\",\"ViewerProtocolPolicy\":\"redirect-to-https\",\"AllowedMethods\":{\"Quantity\":2,\"Items\":[\"GET\",\"HEAD\"]},\"ForwardedValues\":{\"QueryString\":false,\"Cookies\":{\"Forward\":\"none\"}},\"MinTTL\":0,\"DefaultTTL\":86400,\"MaxTTL\":31536000},\"CustomErrorResponses\":{\"Quantity\":1,\"Items\":[{\"ErrorCode\":404,\"ResponsePagePath\":\"/index.html\",\"ResponseCode\":\"200\"}]}}" "$(date +%s)" "$REST_ORIGIN" "$OAC_ID")

              DIST_ID=$(aws cloudfront create-distribution --distribution-config "$DIST_CONFIG" --query "Distribution.Id" --output text)
              echo "CLOUDFRONT_DISTRIBUTION_ID=$DIST_ID" >> $GITHUB_ENV

              # Update bucket policy to allow CloudFront (OAC) access from this distribution
              ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
              POLICY_JSON=$(printf "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Sid\":\"AllowCloudFrontService\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"cloudfront.amazonaws.com\"},\"Action\":\"s3:GetObject\",\"Resource\":[\"arn:aws:s3:::%s/*\"],\"Condition\":{\"StringEquals\":{\"AWS:SourceArn\":\"arn:aws:cloudfront::%s:distribution/%s\",\"AWS:SourceAccount\":\"%s\"}}}]}" "$FALLBACK_BUCKET" "$ACCOUNT_ID" "$DIST_ID" "$ACCOUNT_ID")
              aws s3api put-bucket-policy --bucket "$FALLBACK_BUCKET" --policy "$POLICY_JSON"
              echo "Updated bucket policy to allow CloudFront distribution $DIST_ID"
            else
              DIST_CONFIG=$(printf "{\"CallerReference\":\"deploy-%s\",\"Comment\":\"CI Distribution\",\"Enabled\":true,\"Origins\":{\"Quantity\":1,\"Items\":[{\"Id\":\"S3WebsiteOrigin\",\"DomainName\":\"%s\",\"CustomOriginConfig\":{\"HTTPPort\":80,\"HTTPSPort\":443,\"OriginProtocolPolicy\":\"http-only\"}}]},\"DefaultCacheBehavior\":{\"TargetOriginId\":\"S3WebsiteOrigin\",\"ViewerProtocolPolicy\":\"redirect-to-https\",\"AllowedMethods\":{\"Quantity\":2,\"Items\":[\"GET\",\"HEAD\"]},\"ForwardedValues\":{\"QueryString\":false,\"Cookies\":{\"Forward\":\"none\"}},\"MinTTL\":0,\"DefaultTTL\":86400,\"MaxTTL\":31536000},\"CustomErrorResponses\":{\"Quantity\":1,\"Items\":[{\"ErrorCode\":404,\"ResponsePagePath\":\"/index.html\",\"ResponseCode\":\"200\"}]}}" "$(date +%s)" "$ORIGIN")

              DIST_ID=$(aws cloudfront create-distribution --distribution-config "$DIST_CONFIG" --query "Distribution.Id" --output text)
              echo "CLOUDFRONT_DISTRIBUTION_ID=$DIST_ID" >> $GITHUB_ENV
            fi
          fi

      # ✅ DEPLOY REACT BUILD
      - name: ✅ Deploy to S3 & Invalidate Cache
        run: |
          aws s3 sync dist/ s3://$S3_BUCKET --delete
          aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"

      # ✅ OPTIONAL DOMAIN + ROUTE53 ATTACH
      - name: ✅ Attach Domain (Optional)
        if: ${{ env.DOMAIN_NAME != '' && env.HOSTED_ZONE_ID != '' }}
        run: |
          CF_DOMAIN=$(aws cloudfront get-distribution --id $CLOUDFRONT_DISTRIBUTION_ID --query "Distribution.DomainName" --output text)

          CHANGE_BATCH=$(printf "{\"Changes\":[{\"Action\":\"UPSERT\",\"ResourceRecordSet\":{\"Name\":\"%s\",\"Type\":\"A\",\"AliasTarget\":{\"HostedZoneId\":\"Z2FDTNDATAQYW2\",\"DNSName\":\"%s\",\"EvaluateTargetHealth\":false}}}]}" "$DOMAIN_NAME" "$CF_DOMAIN")

          aws route53 change-resource-record-sets \
            --hosted-zone-id $HOSTED_ZONE_ID \
            --change-batch "$CHANGE_BATCH"

      - name: ✅ Final Output
        run: |
          echo "✅ S3 Website: http://$S3_BUCKET.s3-website.$AWS_REGION.amazonaws.com"
          echo "✅ CloudFront ID: $CLOUDFRONT_DISTRIBUTION_ID"
          echo "✅ Domain: $DOMAIN_NAME"
