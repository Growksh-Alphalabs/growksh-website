name: React Auto Infra Deploy (S3 + CloudFront + Route53)

on:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment (dev or prod)"
        required: false
        default: dev
      s3_bucket:
        description: "Optional: S3 bucket to deploy to (overrides repo variable)"
        required: false
      cloudfront_distribution_id:
        description: "Optional: CloudFront distribution id to invalidate (overrides repo variable)"
        required: false
      domain_name:
        description: "Your domain (example.com)"
        required: false
      hosted_zone_id:
        description: "Route53 Hosted Zone ID"
        required: false

concurrency:
  group: deploy-react
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      DOMAIN_NAME: ${{ github.event.inputs.domain_name }}
      HOSTED_ZONE_ID: ${{ github.event.inputs.hosted_zone_id }}
      # expose workflow inputs and repo variables to steps for resolution
      INPUT_S3_BUCKET: ${{ github.event.inputs.s3_bucket }}
      INPUT_CLOUDFRONT: ${{ github.event.inputs.cloudfront_distribution_id }}
      INPUT_ENVIRONMENT: ${{ github.event.inputs.environment }}
      VARS_S3_BUCKET: ${{ vars.S3_BUCKET || '' }}
      VARS_CLOUDFRONT: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID || '' }}
      EVENT_NAME: ${{ github.event_name }}

    steps:
      - name: ✅ Checkout Repo
        uses: actions/checkout@v4

      - name: ✅ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # frontend build will run after infra is deployed so VITE envs are available

      - name: Validate AWS secrets are present
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then echo "::error::Missing secret AWS_ACCESS_KEY_ID" && exit 1; fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then echo "::error::Missing secret AWS_SECRET_ACCESS_KEY" && exit 1; fi
          if [ -z "${{ secrets.AWS_REGION }}" ]; then echo "::error::Missing secret AWS_REGION" && exit 1; fi
        shell: bash

      - name: ✅ Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ✅ Install SAM CLI
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install aws-sam-cli
        shell: bash

      - name: Determine deploy targets and environment
        id: resolve
        run: |
          echo "Event: $EVENT_NAME"
          if [ "$EVENT_NAME" = "push" ]; then
            echo "DEPLOY_ENV=dev" >> $GITHUB_ENV
            # prefer repository variable S3_BUCKET if available, else use growksh-website bucket
            if [ -n "$VARS_S3_BUCKET" ]; then
              echo "S3_BUCKET=$VARS_S3_BUCKET" >> $GITHUB_ENV
            else
              echo "S3_BUCKET=growksh-website-static-assets" >> $GITHUB_ENV
            fi
            if [ -n "$VARS_CLOUDFRONT" ]; then
              echo "CLOUDFRONT_DISTRIBUTION_ID=$VARS_CLOUDFRONT" >> $GITHUB_ENV
            fi
          else
            # manual dispatch: use input environment and optional overrides
            ENV=${INPUT_ENVIRONMENT:-dev}
            echo "DEPLOY_ENV=$ENV" >> $GITHUB_ENV
            if [ -n "$INPUT_S3_BUCKET" ]; then
              echo "S3_BUCKET=$INPUT_S3_BUCKET" >> $GITHUB_ENV
            elif [ -n "$VARS_S3_BUCKET" ]; then
              echo "S3_BUCKET=$VARS_S3_BUCKET" >> $GITHUB_ENV
            else
              echo "S3_BUCKET=growksh-website-static-assets" >> $GITHUB_ENV
            fi
            if [ -n "$INPUT_CLOUDFRONT" ]; then
              echo "CLOUDFRONT_DISTRIBUTION_ID=$INPUT_CLOUDFRONT" >> $GITHUB_ENV
            elif [ -n "$VARS_CLOUDFRONT" ]; then
              echo "CLOUDFRONT_DISTRIBUTION_ID=$VARS_CLOUDFRONT" >> $GITHUB_ENV
            fi
          fi
          echo "Resolved S3_BUCKET=$S3_BUCKET"
        shell: bash

      # ✅ DEPLOY INFRA (SAM) - includes S3 bucket + CloudFront distribution
      - name: ✅ Build & deploy infra (SAM)
        run: |
          if [ -f infra/sam-template.yaml ]; then
            echo "Infra template found — installing Lambda dependencies and deploying via SAM"

            # Install Lambda dependencies for all functions that declare package.json
            for d in aws-lambda/*; do
              if [ -f "$d/package.json" ]; then
                echo "Installing dependencies in $d"
                (cd "$d" && \
                  if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then \
                    npm ci; \
                  else \
                    npm install; \
                  fi)
              fi
            done

            STACK_NAME="growksh-website"

            # If stack is in ROLLBACK_COMPLETE, delete it first
            STACK_STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].StackStatus" --output text 2>/dev/null || echo "")
            if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ]; then
              echo "Stack is in ROLLBACK_COMPLETE state — deleting it first"
              aws cloudformation delete-stack --stack-name "$STACK_NAME"
              echo "Waiting for stack deletion to complete..."
              aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" 2>/dev/null || true
              sleep 5
            fi

            sam validate --template-file infra/sam-template.yaml
            sam build --template-file infra/sam-template.yaml

            sam deploy \
              --template-file .aws-sam/build/template.yaml \
              --stack-name "$STACK_NAME" \
              --resolve-s3 \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --no-confirm-changeset \
              --no-fail-on-empty-changeset \
              --parameter-overrides \
                StaticSiteBucketName="$S3_BUCKET" \
                VerifySecret="${{ secrets.VERIFY_SECRET }}" \
                SESSourceEmail="${{ secrets.SES_SOURCE_EMAIL || 'noreply@growksh.com' }}" \
                VerifyBaseUrl="${{ secrets.VERIFY_BASE_URL || 'https://d2eipj1xhqte5b.cloudfront.net/auth/verify-email' }}" \
                DebugLogVerify="1" \
                DebugLogOTP="0"

            # Read outputs to wire into the frontend build
            API_BASE=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='UnifiedApiEndpoint'].OutputValue" --output text)
            TABLE_NAME=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='ContactsTableName'].OutputValue" --output text)
            USERPOOL_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='CognitoUserPoolId'].OutputValue" --output text)
            CLIENT_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='CognitoUserPoolClientId'].OutputValue" --output text)
            SITE_BUCKET=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='StaticSiteBucketName'].OutputValue" --output text)
            CF_DIST_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" --output text)
            CF_DOMAIN=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDomainName'].OutputValue" --output text)

            if [ -n "$API_BASE" ] && [ "$API_BASE" != "None" ]; then
              echo "VITE_API_URL=${API_BASE%/}" >> $GITHUB_ENV
              echo "VITE_CONTACT_API_URL=${API_BASE%/}/contact" >> $GITHUB_ENV
            fi
            if [ -n "$TABLE_NAME" ] && [ "$TABLE_NAME" != "None" ]; then
              echo "CONTACTS_TABLE=$TABLE_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$USERPOOL_ID" ] && [ "$USERPOOL_ID" != "None" ]; then
              echo "VITE_COGNITO_USER_POOL_ID=$USERPOOL_ID" >> $GITHUB_ENV
            fi
            if [ -n "$CLIENT_ID" ] && [ "$CLIENT_ID" != "None" ]; then
              echo "VITE_COGNITO_CLIENT_ID=$CLIENT_ID" >> $GITHUB_ENV
            fi
            if [ -n "$SITE_BUCKET" ] && [ "$SITE_BUCKET" != "None" ]; then
              echo "S3_BUCKET=$SITE_BUCKET" >> $GITHUB_ENV
            fi
            if [ -n "$CF_DIST_ID" ] && [ "$CF_DIST_ID" != "None" ]; then
              echo "CLOUDFRONT_DISTRIBUTION_ID=$CF_DIST_ID" >> $GITHUB_ENV
            fi
            if [ -n "$CF_DOMAIN" ] && [ "$CF_DOMAIN" != "None" ]; then
              echo "CLOUDFRONT_DOMAIN_NAME=$CF_DOMAIN" >> $GITHUB_ENV
            fi
          else
            echo "No infra/sam-template.yaml — skipping infra deploy"
          fi

      # ✅ CREATE CLOUDFRONT (FIXED)
      - name: ✅ Build frontend
        run: |
          npm ci
          # export Vite env used by the frontend: VITE_API_URL is read by the code
          # Write Vite env file consumed by the frontend build
          echo "VITE_API_URL=${VITE_API_URL:-}" > .env
          echo "VITE_CONTACT_API_URL=${VITE_CONTACT_API_URL:-}" >> .env
          if [ -n "$VITE_COGNITO_USER_POOL_ID" ]; then
            echo "VITE_COGNITO_USER_POOL_ID=$VITE_COGNITO_USER_POOL_ID" >> .env
          fi
          if [ -n "$VITE_COGNITO_CLIENT_ID" ]; then
            echo "VITE_COGNITO_CLIENT_ID=$VITE_COGNITO_CLIENT_ID" >> .env
          fi
          npm run build

      # ✅ DEPLOY REACT BUILD
      - name: ✅ Deploy to S3 & Invalidate Cache
        run: |
          echo "S3_BUCKET=$S3_BUCKET"
          echo "CLOUDFRONT_DISTRIBUTION_ID=$CLOUDFRONT_DISTRIBUTION_ID"

          if [ -z "$S3_BUCKET" ]; then
            echo "::error::S3_BUCKET is not set"
            exit 1
          fi

          aws s3 sync dist/ s3://$S3_BUCKET --delete

          if [ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
            echo "Invalidating CloudFront distribution: $CLOUDFRONT_DISTRIBUTION_ID"
            aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
          else
            echo "::warning::CLOUDFRONT_DISTRIBUTION_ID not set — skipping cache invalidation"
          fi

      # ✅ OPTIONAL DOMAIN + ROUTE53 ATTACH
      - name: ✅ Attach Domain (Optional)
        if: ${{ env.DOMAIN_NAME != '' && env.HOSTED_ZONE_ID != '' }}
        run: |
          CF_DOMAIN=${CLOUDFRONT_DOMAIN_NAME:-$(aws cloudfront get-distribution --id $CLOUDFRONT_DISTRIBUTION_ID --query "Distribution.DomainName" --output text)}

          cat <<EOF > dns.json
          {
            "Changes": [{
              "Action": "UPSERT",
              "ResourceRecordSet": {
                "Name": "$DOMAIN_NAME",
                "Type": "A",
                "AliasTarget": {
                  "HostedZoneId": "Z2FDTNDATAQYW2",
                  "DNSName": "$CF_DOMAIN",
                  "EvaluateTargetHealth": false
                }
              }
            }]
          }
          EOF

          aws route53 change-resource-record-sets \
            --hosted-zone-id $HOSTED_ZONE_ID \
            --change-batch file://dns.json

      - name: ✅ Final Output
        run: |
          echo "✅ S3 Bucket: $S3_BUCKET"
          echo "✅ CloudFront ID: $CLOUDFRONT_DISTRIBUTION_ID"
          if [ -n "$CLOUDFRONT_DOMAIN_NAME" ]; then
            echo "✅ CloudFront URL: https://$CLOUDFRONT_DOMAIN_NAME"
          fi
          echo "✅ Domain: $DOMAIN_NAME"
