# Deployment Configuration Guide

## Overview
This document outlines which values are account-specific and must be provided during deployment, and which are auto-generated or use sensible defaults.

---

## Account-Specific Constants (Must Provide)

### 1. **AWS Account ID**
- **Value**: Your AWS Account ID (e.g., `720427058396`)
- **Type**: Auto-detected via CloudFormation pseudo-parameter `${AWS::AccountId}`
- **Where used**: IAM roles, resource ARNs
- **How to get**: Run `aws sts get-caller-identity --query Account --output text`

### 2. **AWS Region**
- **Value**: Deployment region (e.g., `ap-south-1`, `us-east-1`)
- **Type**: Auto-detected via CloudFormation pseudo-parameter `${AWS::Region}`
- **Where used**: API Gateway endpoints, Lambda regions, SES
- **How to set**: Configure via `aws configure` or use `--region` flag

### 3. **Environment Name**
- **Value**: Environment identifier (e.g., `dev`, `staging`, `prod`, `feature-77d07ae1`)
- **Type**: Parameter passed to CloudFormation
- **Where used**: Resource naming, separation of stacks
- **How to provide**: Via `--parameter-overrides Environment=<value>`

### 4. **SES Verified Email**
- **Value**: Email address verified in AWS SES (e.g., `noreply@growksh.com`)
- **Type**: Must exist in AWS account's SES verified identities
- **Where used**: Sending OTPs and verification emails
- **How to verify**: 
  ```bash
  aws ses verify-email-identity --email-address noreply@growksh.com --region <region>
  aws ses verify-domain-identity --domain growksh.com --region <region>
  ```
- **Note**: Account must be out of SES sandbox for production use

### 5. **Frontend URLs**
| Parameter | Example | Purpose |
|-----------|---------|---------|
| **VerifyBaseUrl** | `https://d12jf2jvld5mg4.cloudfront.net/auth/verify-email` | Email verification link destination |
| **VITE_API_URL** | `https://8hz8oz0aef.execute-api.ap-south-1.amazonaws.com/feature-77d07ae1` | Backend API endpoint |
| **VITE_COGNITO_USER_POOL_ID** | `ap-south-1_J0S26HesM` | Cognito user pool ID (auto-generated) |
| **VITE_COGNITO_CLIENT_ID** | `3cviqovg35pjt8n9e90gp8pum4` | Cognito app client ID (auto-generated) |

### 6. **Verify Secret (HMAC Key)**
- **Value**: Random 32+ character string (e.g., `CQxrZPyIjvXwMcNpzHaFDdASkWLYqthO`)
- **Type**: Generated or provided
- **Where used**: Signing verification links, must match between Cognito Lambdas and API Lambdas
- **How to generate**:
  ```powershell
  # PowerShell
  $secret = -join ((65..90) + (97..122) | Get-Random -Count 32 | % {[char]$_})
  Write-Host $secret
  ```
  ```bash
  # Bash
  openssl rand -base64 32 | tr -d '=+/' | cut -c1-32
  ```

### 7. **Lambda Code S3 Bucket**
- **Value**: S3 bucket containing Lambda ZIP files (e.g., `growksh-website-lambda-code-dev`)
- **Type**: Can be provided or auto-created by stack
- **Where used**: Storing packaged Lambda functions
- **Options**:
  - **Option A**: Provide existing bucket: Pass `LambdaCodeBucketName=<bucket-name>`
  - **Option B**: Let stack create: Pass empty string `LambdaCodeBucketName=` (or omit parameter)

### 8. **Lambda Code Source Environment**
- **Value**: Environment suffix from code packaging (e.g., `dev`, `feature-77d07ae1`)
- **Type**: Should match the environment used when packaging Lambdas
- **Where used**: Finding correct ZIP files in S3 (e.g., `auth/signup-dev.zip`)
- **How to provide**: Via `--parameter-overrides LambdaCodeSourceEnv=<value>`

---

## Auto-Generated Values (No Action Needed)

| Value | Generated By | Example |
|-------|--------------|---------|
| Cognito User Pool ID | Stack 02 | `ap-south-1_J0S26HesM` |
| Cognito Client ID | Stack 02 | `3cviqovg35pjt8n9e90gp8pum4` |
| API Gateway ID | Stack 06 | `8hz8oz0aef` |
| API Endpoint | Stack 06 | `https://8hz8oz0aef.execute-api.ap-south-1.amazonaws.com/...` |
| Lambda ARNs | Stacks 07 & 08 | Exported for use by API Gateway |
| CloudFront Distribution | Stack 05 | Auto-generated |

---

## Default Values (Can Override)

| Parameter | Default | Override If |
|-----------|---------|------------|
| `Environment` | `dev` | Deploying to staging/prod/feature branch |
| `SESSourceEmail` | `noreply@growksh.com` | Using different sender email |
| `VerifyBaseUrl` | `https://dev.growksh.com/auth/verify-email` | Different frontend domain |
| `DebugLogOTP` | `0` | Need detailed Lambda logs (set to `1`) |
| `LambdaCodeSourceEnv` | `dev` | Code packaged with different environment suffix |
| `LambdaCodeBucketName` | `` (empty) | Using pre-existing bucket |

---

## Deployment Parameters by Stack

### Stack 02: Cognito User Pool
```bash
aws cloudformation deploy \
  --stack-name growksh-website-cognito-<environment> \
  --template-file infra/cloudformation/02-cognito-stack.yaml \
  --parameter-overrides \
    Environment=<environment> \
    EnableTriggers=true  # ‚Üê Usually always 'true' for fresh deployments
```

### Stack 07: Cognito Lambdas
```bash
aws cloudformation deploy \
  --stack-name growksh-website-cognito-lambdas-<environment> \
  --template-file infra/cloudformation/07-cognito-lambdas-stack.yaml \
  --parameter-overrides \
    Environment=<environment> \
    LambdaCodeSourceEnv=<code-env> \
    LambdaCodeBucketName=<bucket-name-or-empty> \
    SESSourceEmail=noreply@growksh.com \
    VerifyBaseUrl=https://<frontend-url>/auth/verify-email \
    VerifySecret=<32-char-random-string> \
  --capabilities CAPABILITY_NAMED_IAM
```

### Stack 08: API Lambdas
```bash
aws cloudformation deploy \
  --stack-name growksh-website-api-lambdas-<environment> \
  --template-file infra/cloudformation/08-api-lambdas-stack.yaml \
  --parameter-overrides \
    Environment=<environment> \
    LambdaCodeSourceEnv=<code-env> \
    LambdaCodeBucketName=<bucket-name-or-empty> \
    VerifyBaseUrl=https://<frontend-url>/auth/verify-email \
    VerifySecret=<32-char-random-string> \
  --capabilities CAPABILITY_NAMED_IAM
```

### Stack 06: API Gateway
```bash
aws cloudformation deploy \
  --stack-name growksh-website-api-<environment> \
  --template-file infra/cloudformation/06-api-gateway-stack.yaml \
  --parameter-overrides \
    Environment=<environment>
```

---

## Frontend Runtime Config

**File**: `public/runtime-config.js`

Must be updated **after** CloudFormation deployments to include auto-generated values:

```javascript
window.__GROWKSH_RUNTIME_CONFIG__ = {
  // ACCOUNT-SPECIFIC (from CloudFormation exports or manual lookup)
  VITE_COGNITO_USER_POOL_ID: 'ap-south-1_J0S26HesM',        // Get from Stack 02 output
  VITE_COGNITO_CLIENT_ID: '3cviqovg35pjt8n9e90gp8pum4',     // Get from Stack 02 output
  VITE_API_URL: 'https://8hz8oz0aef.execute-api.ap-south-1.amazonaws.com/feature-77d07ae1', // Get from Stack 06 output
  VITE_AWS_REGION: 'ap-south-1',                             // Your deployment region
  
  // OPTIONAL
  VITE_USE_FAKE_AUTH: '0',  // Set to '1' for testing without real Cognito
};
```

**How to get values after deployment**:
```bash
# Cognito User Pool ID
aws cloudformation describe-stacks \
  --stack-name growksh-website-cognito-<environment> \
  --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' \
  --output text

# Cognito Client ID
aws cloudformation describe-stacks \
  --stack-name growksh-website-cognito-<environment> \
  --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' \
  --output text

# API Endpoint
aws cloudformation describe-stacks \
  --stack-name growksh-website-api-<environment> \
  --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
  --output text
```

---

## Summary: What to Provide vs. Auto-Generated

### You Must Provide (Before Deployment)
1. ‚úÖ **AWS Account ID** - Automatic via CLI config
2. ‚úÖ **AWS Region** - Specify during deploy
3. ‚úÖ **Environment Name** - Pass as parameter
4. ‚úÖ **SES Verified Email** - Verify in SES console
5. ‚úÖ **VerifySecret** - Generate before deploy
6. ‚úÖ **Frontend URLs** - Know your domain
7. ‚úÖ **Lambda Code Bucket** - Create or let stack create

### Automatically Generated (After Deployment)
1. üîÑ **Cognito User Pool ID** - Get from Stack 02 outputs
2. üîÑ **Cognito Client ID** - Get from Stack 02 outputs
3. üîÑ **API Gateway Endpoint** - Get from Stack 06 outputs
4. üîÑ **Lambda Function ARNs** - Exported by Stacks 07 & 08
5. üîÑ **S3 Bucket (if auto-created)** - Named with Account ID, Environment, Region

---

## Deployment Checklist

- [ ] AWS account configured (`aws configure`)
- [ ] SES email verified for the region
- [ ] Environment name chosen (dev/staging/prod/feature-XXX)
- [ ] VerifySecret generated (32+ random chars)
- [ ] Lambda code packaged and uploaded to S3
- [ ] CloudFormation stacks deployed in order: 02 ‚Üí 07 ‚Üí 02 (update) ‚Üí 08 ‚Üí 06
- [ ] `public/runtime-config.js` updated with outputs
- [ ] Frontend redeployed or rebuilt with new config

